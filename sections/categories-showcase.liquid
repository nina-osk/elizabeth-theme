<div class="w-full bg-white">
  <div class="mx-auto max-w-7xl px-6 md:px-12 lg:px-32 py-12 md:py-16 lg:py-20">
    <!-- Header -->
    <div class="text-center mb-8 md:mb-12 lg:mb-16">
      <h2 class="text-2xl md:text-3xl lg:text-4xl font-semibold text-gray-800 mb-2 md:mb-3 px-8 md:px-16 lg:px-24 leading-relaxed">
        {{ section.settings.title }}
      </h2>
      <p class="text-xs md:text-sm text-gray-500">
        {{ section.settings.subtitle }}
      </p>
    </div>

    <!-- Mobile View (Carrusel rotativo) -->
    <div class="md:hidden mb-8 px-4">
      <div class="relative w-full overflow-visible" style="height: 450px;">
        <div class="mobile-carousel-container relative flex items-center justify-center" style="height: 100%;">
          {% assign cards = (1..6) %}
          {% for i in cards %}
            {% assign prod_key = 'category_' | append: i | append: '_product' %}
            {% assign label_key = 'category_' | append: i | append: '_label' %}
            {% assign prod = section.settings[prod_key] %}
            
            <div class="mobile-carousel-item absolute rounded-lg cursor-pointer transition-all duration-500 overflow-hidden shadow-xl bg-white" 
                 data-index="{{ forloop.index0 }}" 
                 style="width: 240px; height: 340px; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 2px solid #ffffff;">
              <div class="w-full h-full flex flex-col bg-white">
                {% if prod != blank and prod.featured_media %}
                  <div class="h-2/3 w-full overflow-hidden bg-gray-100">
                    {{ prod.featured_media | image_url: width: 480 | image_tag: alt: prod.title, class: 'w-full h-full object-contain bg-white', loading: 'lazy', width: 480, height: 480 }}
                  </div>
                  <div class="h-1/3 w-full px-4 py-3 flex flex-col justify-center border-t border-gray-200 bg-white">
                    <p class="text-sm text-gray-500 truncate">{{ prod.vendor }}</p>
                    <a href="{{ prod.url }}" class="text-lg font-semibold text-gray-800 truncate hover:text-amber-600 transition-colors">{{ prod.title }}</a>
                    <a href="{{ prod.url }}" class="text-lg font-bold text-black hover:text-amber-600 transition-colors">{{ prod.price | money }}</a>
                  </div>
                {% else %}
                  <div class="h-full w-full flex items-center justify-center bg-stone-100 text-center px-2">
                    <span class="text-sm font-medium text-gray-600">
                      {{ section.settings[label_key] | default: 'Producto' }}
                    </span>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Mobile Controls -->
    <div class="md:hidden flex justify-center gap-2 mb-8">
      <button id="mobile-prev-btn" class="px-3 py-1 border-2 border-black text-black text-xs font-semibold uppercase hover:bg-black hover:text-white transition-colors rounded">
        ← Anterior
      </button>
      <button id="mobile-next-btn" class="px-3 py-1 border-2 border-black text-black text-xs font-semibold uppercase hover:bg-black hover:text-white transition-colors rounded">
        Siguiente →
      </button>
    </div>

    <!-- Desktop View (3D Carousel) -->
    <div class="hidden md:flex justify-center items-center mb-12" style="perspective: 1200px; height: 700px;">
      <div class="carousel-3d relative" style="width: 100%; height: 100%; transform-style: preserve-3d;">

        {% assign cards = (1..6) %}
        {% for i in cards %}
          {% assign prod_key = 'category_' | append: i | append: '_product' %}
          {% assign label_key = 'category_' | append: i | append: '_label' %}
          {% assign prod = section.settings[prod_key] %}
          
          <div class="carousel-item absolute rounded-lg cursor-pointer transition-all duration-700 overflow-hidden shadow-2xl bg-white" 
               data-index="{{ forloop.index0 }}" 
               style="width: 280px; height: 400px; left: 50%; top: 50%; transform-origin: center; margin-left: -140px; margin-top: -200px; border: 2px solid #ffffff;">
            <div class="w-full h-full flex flex-col">
              {% if prod != blank and prod.featured_media %}
                <div class="h-3/4 w-full overflow-hidden bg-gray-100">
                  {{ prod.featured_media | image_url: width: 560 | image_tag: alt: prod.title, class: 'w-full h-full object-contain', loading: 'lazy', width: 560, height: 560 }}
                </div>
                <div class="h-1/4 w-full px-4 py-3 flex flex-col justify-center border-t-2 border-gray-200">
                  <p class="text-sm text-gray-500 truncate">{{ prod.vendor }}</p>
                  <a href="{{ prod.url }}" class="text-xl font-bold text-gray-800 truncate hover:text-amber-600 transition-colors">{{ prod.title }}</a>
                  <a href="{{ prod.url }}" class="text-xl font-bold text-black hover:text-amber-600 transition-colors">{{ prod.price | money }}</a>
                </div>
              {% else %}
                <div class="h-full w-full flex items-center justify-center bg-stone-100 text-center px-4">
                  <span class="text-base font-semibold text-gray-700">
                    {{ section.settings[label_key] | default: 'Producto' }}
                  </span>
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}

      </div>
    </div>

    <!-- Desktop Controls -->
    <div class="hidden md:flex justify-center gap-4 lg:gap-6">
      <button id="zoom-in-btn" class="px-6 py-3 bg-black text-white font-semibold rounded-lg hover:bg-gray-800 transition-all">
        Zoom
      </button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Mobile Carousel
    const mobileContainer = document.querySelector('.mobile-carousel-container');
    const mobileItems = document.querySelectorAll('.mobile-carousel-item');
    const mobilePrevBtn = document.getElementById('mobile-prev-btn');
    const mobileNextBtn = document.getElementById('mobile-next-btn');

    if (mobileItems.length > 0) {
      let mobileCurrentIndex = 0;

      function updateMobileCarousel() {
        mobileItems.forEach((item, index) => {
          const diff = index - mobileCurrentIndex;
          
          if (diff === 0) {
            // Tarjeta principal (al frente, centrada)
            item.style.transform = 'translate(-50%, -50%) scale(1) rotate(0deg)';
            item.style.opacity = '1';
            item.style.zIndex = '30';
            item.style.top = '50%';
            item.style.left = '50%';
          } else if (diff === 1 || (mobileCurrentIndex === mobileItems.length - 1 && index === 0)) {
            // Segunda tarjeta (detrás a la derecha)
            item.style.transform = 'translate(-40%, -55%) scale(0.9) rotate(3deg)';
            item.style.opacity = '1';
            item.style.zIndex = '20';
            item.style.top = '50%';
            item.style.left = '50%';
          } else if (diff === 2 || (mobileCurrentIndex >= mobileItems.length - 2 && index < 2)) {
            // Tercera tarjeta (más atrás a la derecha)
            item.style.transform = 'translate(-30%, -60%) scale(0.8) rotate(5deg)';
            item.style.opacity = '1';
            item.style.zIndex = '10';
            item.style.top = '50%';
            item.style.left = '50%';
          } else if (diff === -1 || (mobileCurrentIndex === 0 && index === mobileItems.length - 1)) {
            // Tarjeta anterior (detrás a la izquierda)
            item.style.transform = 'translate(-60%, -55%) scale(0.9) rotate(-3deg)';
            item.style.opacity = '1';
            item.style.zIndex = '20';
            item.style.top = '50%';
            item.style.left = '50%';
          } else {
            // Tarjetas ocultas
            item.style.transform = 'translate(-50%, -50%) scale(0.7) rotate(0deg)';
            item.style.opacity = '0';
            item.style.zIndex = '1';
            item.style.top = '50%';
            item.style.left = '50%';
          }
        });
      }

      if (mobilePrevBtn) {
        mobilePrevBtn.addEventListener('click', () => {
          mobileCurrentIndex = (mobileCurrentIndex - 1 + mobileItems.length) % mobileItems.length;
          updateMobileCarousel();
        });
      }

      if (mobileNextBtn) {
        mobileNextBtn.addEventListener('click', () => {
          mobileCurrentIndex = (mobileCurrentIndex + 1) % mobileItems.length;
          updateMobileCarousel();
        });
      }

      // Soporte para swipe en móvil
      let touchStartX = 0;
      let touchEndX = 0;

      mobileContainer.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
      });

      mobileContainer.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      });

      function handleSwipe() {
        if (touchEndX < touchStartX - 50) {
          // Swipe izquierda (siguiente)
          mobileCurrentIndex = (mobileCurrentIndex + 1) % mobileItems.length;
          updateMobileCarousel();
        }
        if (touchEndX > touchStartX + 50) {
          // Swipe derecha (anterior)
          mobileCurrentIndex = (mobileCurrentIndex - 1 + mobileItems.length) % mobileItems.length;
          updateMobileCarousel();
        }
      }

      // Toque en las tarjetas para avanzar
      mobileItems.forEach((item, index) => {
        item.addEventListener('click', (e) => {
          // Si se clickea un enlace, no hacer nada
          if (e.target.tagName === 'A') {
            return;
          }
          
          // Prevenir el comportamiento por defecto
          e.preventDefault();
          
          const diff = index - mobileCurrentIndex;
          
          // Si toca la tarjeta principal, avanza al siguiente
          if (diff === 0) {
            mobileCurrentIndex = (mobileCurrentIndex + 1) % mobileItems.length;
            updateMobileCarousel();
          }
          // Si toca una tarjeta visible (derecha o izquierda), va a esa tarjeta
          else if (diff === 1 || (mobileCurrentIndex === mobileItems.length - 1 && index === 0)) {
            mobileCurrentIndex = index;
            updateMobileCarousel();
          }
          else if (diff === -1 || (mobileCurrentIndex === 0 && index === mobileItems.length - 1)) {
            mobileCurrentIndex = index;
            updateMobileCarousel();
          }
          // Si toca cualquier otra tarjeta no visible, avanza al siguiente
          else {
            mobileCurrentIndex = (mobileCurrentIndex + 1) % mobileItems.length;
            updateMobileCarousel();
          }
        });

        // Agregar cursor pointer para indicar que es clickeable
        item.style.cursor = 'pointer';
      });

      updateMobileCarousel();
    }

    // Desktop Carousel
    const items = document.querySelectorAll('.carousel-item');
    const zoomBtn = document.getElementById('zoom-in-btn');

    if (items.length > 0) {
      const itemCount = items.length;
      const radius = 350; // Radio del carrusel
      let currentRotation = 0;
      let currentZoom = 1;

      function updateCarousel() {
        items.forEach((item, index) => {
          const angle = (360 / itemCount) * index + currentRotation;
          const radians = (angle * Math.PI) / 180;
          const x = Math.cos(radians) * radius;
          const z = Math.sin(radians) * radius;
          const zNormalized = (z + radius) / (radius * 2);
          const scale = 0.7 + zNormalized * 0.3;
          const opacity = 1;

          item.style.transform = `translateX(${x}px) translateZ(${z}px) scale(${scale})`;
          item.style.opacity = opacity;
          item.style.zIndex = Math.round(z);
        });
      }

      function rotateToItem(index) {
        const targetRotation = -(360 / itemCount) * index;
        currentRotation = targetRotation;
        updateCarousel();
      }

      items.forEach((item, index) => {
        item.addEventListener('click', (e) => {
          if (e.target.tagName === 'A') {
            return;
          }
          rotateToItem(index);
        });
      });

      if (zoomBtn) {
        zoomBtn.addEventListener('click', () => {
          currentZoom = currentZoom === 1 ? 1.15 : 1;
          items.forEach((item) => {
            item.style.transform += ` scale(${currentZoom})`;
          });
        });
      }

      rotateToItem(2);
    }
  });
</script>

{% schema %}
{
  "name": "Categories Showcase",
  "settings": [
    { "type": "text", "id": "title", "label": "Título", "default": "Diseños Únicos Y Elegantes Para Tu Día a Día" },
    { "type": "text", "id": "subtitle", "label": "Subtítulo", "default": "Próximos elementos básicos en tu rotación" },
    
    { "type": "text", "id": "category_1_label", "label": "Categoría 1 - Etiqueta", "default": "Aretes" },
    { "type": "product", "id": "category_1_product", "label": "Categoría 1 - Producto" },
    
    { "type": "text", "id": "category_2_label", "label": "Categoría 2 - Etiqueta", "default": "Collar" },
    { "type": "product", "id": "category_2_product", "label": "Categoría 2 - Producto" },
    
    { "type": "text", "id": "category_3_label", "label": "Categoría 3 - Etiqueta", "default": "Pulsera" },
    { "type": "product", "id": "category_3_product", "label": "Categoría 3 - Producto" },
    
    { "type": "text", "id": "category_4_label", "label": "Categoría 4 - Etiqueta", "default": "Anillo" },
    { "type": "product", "id": "category_4_product", "label": "Categoría 4 - Producto" },
    
    { "type": "text", "id": "category_5_label", "label": "Categoría 5 - Etiqueta", "default": "Tobillera" },
    { "type": "product", "id": "category_5_product", "label": "Categoría 5 - Producto" },
    
    { "type": "text", "id": "category_6_label", "label": "Categoría 6 - Etiqueta", "default": "Cadena" },
    { "type": "product", "id": "category_6_product", "label": "Categoría 6 - Producto" }
  ],
  "presets": [
    { "name": "Categories Showcase" }
  ]
}
{% endschema %}
